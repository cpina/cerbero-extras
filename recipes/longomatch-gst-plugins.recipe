import shutil
from cerbero.build.cookbook import CookBook


class Recipe(recipe.Recipe):
    name = 'longomatch-gstreamer-plugins'
    version = '1.0.0'
    stype = SourceType.CUSTOM
    btype = BuildType.CUSTOM
    deps = ['longomatch', 'gst-plugins-bad', 'gst-plugins-ugly', 'gst-ffmpeg']

    files_longomatch = [
        'lib/longomatch/plugins/LongoMatch.Plugins.GStreamer.dll',
        'lib/longomatch/plugins/LongoMatch.Plugins.GStreamer.dll.config',
        'lib/longomatch/plugins/LongoMatch.Plugins.GStreamer.dll.mdb',
    ]

    _files = ['a52dec:libs', 'opencore-amr:libs', 'libmad:libs', 'libmpeg2:libs',
              'faad2:libs', 'libdca:libs', 'x264:libs', 'lame:libs', 'faac:libs',
              'gst-ffmpeg:plugins_codecs_restricted',
              'gst-plugins-ugly:plugins_codecs_restricted',
              'gst-plugins-bad:plugins_codecs_restricted']

    def prepare(self):
        self.pluginsdir = 'lib/longomatch/plugins/gstreamer-0.10'

    def dist_files_list(self):
        return recipe.Recipe.dist_files_list(self) + self._get_files_list()[1]

    def post_install(self):
        src_files, _ = self._get_files_list()
        pluginsdir = os.path.join(self.config.prefix, self.pluginsdir)
        if not os.path.exists(pluginsdir):
            os.makedirs (pluginsdir)
        for f in src_files:
            shutil.copy(os.path.join(self.config.prefix, f), pluginsdir)

    def _get_files_list(self):
        cookbook = CookBook(self.config)
        recipes_files = {}
        for r in self._files:
            l = r.split(':')
            recipes_files[l[0]] = l[1:]

        files = []
        for recipe_name, categories in recipes_files.iteritems():
            recipe = cookbook.get_recipe(recipe_name)
            if len(categories) == 0:
                rfiles = recipe.dist_files_list()
            else:
                rfiles = recipe.files_list_by_categories(categories)
            files.extend(rfiles)
        return (files, [os.path.join(self.pluginsdir, f.split('/')[-1]) for f in files])
